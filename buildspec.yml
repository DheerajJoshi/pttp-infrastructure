version: 0.2

env:
  variables:
    TF_IN_AUTOMATION: true
    TF_VAR_enable_peering: false
  parameter-store:
    TF_VAR_ost_vpc_id: "/codebuild/pttp-ci-infrastructure-core-pipeline/$ENV/ost_vpc_id"

phases:
  install:
    commands:
      - wget -O terraform.zip https://releases.hashicorp.com/terraform/0.12.27/terraform_0.12.27_linux_amd64.zip
      - unzip terraform.zip
      - mv terraform /bin

  build:
    commands:
      - terraform init -no-color --backend-config="key=terraform.$ENV.state"
      - terraform workspace new $ENV || true
      - terraform workspace select $ENV
      - terraform plan -no-color -var="assume_role=$ASSUME_ROLE_ARN" -var="owner-email=pttp@justice.gov.uk" -var="ost_aws_account_id=$OST_AWS_ACCOUNT_ID" -var="ost_vpc_cidr_block=$OST_VPC_CIDR_BLOCK"
      - terraform apply --auto-approve -no-color -input=false -var="assume_role=$ASSUME_ROLE_ARN" -var="owner-email=pttp@justice.gov.uk" -var="ost_vpc_id=$OST_VPC_ID" -var="ost_aws_account_id=$OST_AWS_ACCOUNT_ID" -var="ost_vpc_cidr_block=$OST_VPC_CIDR_BLOCK"
